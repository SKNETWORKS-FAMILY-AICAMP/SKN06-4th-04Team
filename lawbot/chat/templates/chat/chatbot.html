{% extends "layout.html" %}

{% block style %}
  <style>
    .chat-container {
      width: 100%;
      background: var(--background-light-blue);
      height: calc(100vh - 100px);
      min-height: 100px;
    }

    .chat-box {
      height: 100%;
      overflow-y: auto;
    }

    .input-container {
      display: flex;
      column-gap: 0.5rem;
      margin:6px 8px;
    }

    .input-container input {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      line-height: 30px;
    }
    .input-container input:disabled{
      background: #f5f5f5;
    }
    .input-container input:focus {
      outline: none;
    }

    .input-container .btn.btn-primary {
      width: 80px;
      padding: 10px;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      line-height: initial;
    }

    .chat-message {
      margin: 0.5rem 1rem;
    }

    .user-message {}
  </style>
{% endblock %}

{% block content %}
  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>
    <div class="input-container">
      <input type="text" id="user-input" ">
      <button id="send-button" class="btn btn-primary">전송</button>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
    const sendButton = document.getElementById("send-button");
    const userInput = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");

    async function askQuestion() {
      const question = userInput
        .value
        .trim();
      if (!question) 
        return;
      
      const userMessage = document.createElement("div");
      userMessage
        .classList
        .add("chat-message", "user-message");
      userMessage.textContent = "사용자: " + question;
      chatBox.appendChild(userMessage);
      userInput.value = "";
      userInput.disabled = true;
      

      try {
        const response = await fetch("/chat/get-answer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({question})
        });
        const data = await response.json();

        const botMessage = document.createElement("div");
        botMessage
          .classList
          .add("chat-message");
        botMessage.textContent = data.answer || "오류: " + (
        data.error || "알 수 없는 오류가 발생했습니다.");
        chatBox.appendChild(botMessage);
      } catch (error) {
        const errorMessage = document.createElement("div");
        errorMessage
          .classList
          .add("chat-message");
        errorMessage.textContent = "서버와 통신 중 오류가 발생했습니다.";
        chatBox.appendChild(errorMessage);
      }

      userInput.disabled = false;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendButton.addEventListener("click", async () => {
      await askQuestion()
    });

    userInput.addEventListener('keydown', async (e)=> {
      if (e.key === "Enter" && !e.shiftKey) {
        await askQuestion()
      };
    }, true);
  </script>
{% endblock %}
