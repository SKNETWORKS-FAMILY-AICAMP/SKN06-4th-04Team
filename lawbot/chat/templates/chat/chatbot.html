{% extends "layout.html" %}
{% load static %}

{% block style %}
  <style>
    .chat-container {
      width: 100%;
      background: var(--background-light-blue);
      height: calc(100vh - 110px);
      padding-top: 10px;
      min-height: 100px;
    }
    .input-container {
      display: flex;
      column-gap: 0.5rem;
      margin:6px 8px;
    }

    .input-container input {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      line-height: 30px;
      padding: 0 1rem;
    }

    .input-container input:disabled{
      background: #f5f5f5;
    }

    .input-container input:focus {
      outline: none;
    }

    .input-container .btn.btn-primary {
      width: 96px;
      padding: 10px;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      line-height: initial;
    }

    .chat-box {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
    }

    .chat-message {
      margin: 0.5rem 1rem 0 1rem;
    }

    .chat-message .chat-info{
      display: flex;
      align-items: flex-end;
      column-gap:1rem;
      height: 44px;
    } 

    .chat-message .chat-info p{
      position: relative;
      line-height: 38px;
      font-size: 13px;
      color: var(--color-gray);
      margin:0;
      margin-left: 50px;
    }

    .chat-message .chat-info p:before {
      position: absolute;
      width: 40px;
      height: 40px;
      content: url('/static/img/icon-profile-red.svg');
      display: block;
      left: -50px;
      top: -10px;
    }
    .chat-message .chat-bubble {
      padding: .9375rem 1.5rem;
      display: inline-block;
      border-radius: 0 20px 20px;
      background: #fff;
      line-height: 20px;
      max-width: 90%;
    }

    .chat-message.user-message .chat-info {
      justify-content: right
    }

    .chat-message.user-message .chat-info p {
      margin-left: 0;
      margin-right: 50px;
    }

    .chat-message.user-message .chat-info p {
      margin-left: 0;
      margin-right: 50px;
    }

    .chat-message.user-message .chat-bubble {
      border-radius: 20px 0 20px 20px;
      float: right;
      background: #555C64;
      color: #fff;
    }

    .chat-message.user-message .chat-info p:before {
      right: -50px;
      left: initial;
      content: url('/static/img/icon-profile.svg');
    }
  </style>
{% endblock %}

{% block content %}
  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>
    <div class="input-container">
      <input type="text" id="user-input">
      <button id="send-button" class="btn btn-primary">전송</button>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
    const sendButton = document.getElementById("send-button");
    const userInput = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");

    async function askQuestion() {
      const question = userInput.value.trim();
      if (!question) 
        return;
      
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const time = `${hours}:${minutes}`;

      const userMessage = document.createElement("div");
      userMessage.classList.add("chat-message", "user-message");

      const userInfo = document.createElement("div");
      userInfo.classList.add("chat-info");
      const chatTime = document.createElement("p")
      chatTime.textContent = time;
      userInfo.appendChild(chatTime);
      userMessage.appendChild(userInfo);

      const userBubble = document.createElement("div");
      userBubble.classList.add("chat-bubble");
      userBubble.textContent = question;
      userMessage.appendChild(userBubble);

      chatBox.appendChild(userMessage);
      userInput.value = "";
      userInput.disabled = true;
      

      try {
        const response = await fetch("/chat/get-answer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({question})
        });
        
        const data = await response.json();

        const respondNow = new Date();
        const hours = String(respondNow.getHours()).padStart(2, '0');
        const minutes = String(respondNow.getMinutes()).padStart(2, '0');
        const respondTime = `${hours}:${minutes}`;

        const botMessage = document.createElement("div");
        botMessage.classList.add("chat-message");

        const chatInfo = document.createElement("div");
        chatInfo.classList.add("chat-info");
        
        const botTime = document.createElement("p")
        botTime.textContent = respondTime;
        chatInfo.appendChild(botTime);
        botMessage.appendChild(chatInfo);

        const botBubble = document.createElement("div");
        botBubble.classList.add("chat-bubble");
        botBubble.textContent = data.answer || "오류: " + (
          data.error || "알 수 없는 오류가 발생했습니다.");
        botMessage.appendChild(botBubble);

        chatBox.appendChild(botMessage);
        
      } catch (error) {
        const respondNow = new Date();
        const hours = String(respondNow.getHours()).padStart(2, '0');
        const minutes = String(respondNow.getMinutes()).padStart(2, '0');
        const respondTime = `${hours}:${minutes}`;

        const botMessage = document.createElement("div");
        botMessage.classList.add("chat-message");

        const chatInfo = document.createElement("div");
        chatInfo.classList.add("chat-info");
        
        const botTime = document.createElement("p")
        botTime.textContent = respondTime;
        chatInfo.appendChild(botTime);
        botMessage.appendChild(chatInfo);

        const botBubble = document.createElement("div");
        botBubble.classList.add("chat-bubble");
        botBubble.textContent = "알 수 없는 오류가 발생했습니다."
        botMessage.appendChild(botBubble);

        chatBox.appendChild(botMessage);
        
      }

      userInput.disabled = false;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendButton.addEventListener("click", async () => {
      await askQuestion()
    });

    userInput.addEventListener('keydown', async (e)=> {
      if (e.key === "Enter" && !e.shiftKey) {
        await askQuestion()
      };
    }, true);
  </script>
{% endblock %}
